<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMOo Pro Chat + Media</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #00a884; --chat-bg: #efeae2; --my-msg: #d9fdd3; --friend-msg: #ffffff; --danger: #ea0038; --online: #1fa33e; --bg-main: #ffffff; --text-main: #111b21; --header-bg: #ffffff; }
        
        /* إعدادات الوضع الليلي */
        body.dark-mode { --bg-main: #111b21; --text-main: #e9edef; --chat-bg: #0b141a; --my-msg: #005c4b; --friend-msg: #202c33; --header-bg: #202c33; }
        body.dark-mode .app-container, body.dark-mode header, body.dark-mode .chats-container, body.dark-mode .chat-card, body.dark-mode .chat-header { background-color: var(--bg-main); color: var(--text-main); }
        body.dark-mode .chat-info b { color: var(--text-main); }
        body.dark-mode .message { color: #e9edef; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f0f2f5; overflow: hidden; user-select: none; transition: background 0.3s; }
        
        .app-container { max-width: 500px; margin: 0 auto; background: var(--bg-main); height: 100vh; position: relative; display: flex; flex-direction: column; }
        header { padding: 15px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); background: var(--header-bg); z-index: 10; }
        header h2 { color: var(--primary-color); font-size: 22px; }
        
        .chats-container { flex: 1; overflow-y: auto; background: var(--bg-main); }
        .chat-card { display: flex; padding: 12px 16px; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; position: relative; }
        
        .avatar-wrapper { position: relative; margin-left: 15px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #e9edef; display: flex; align-items: center; justify-content: center; color: #adb5bd; font-size: 24px; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: #ccc; border: 2px solid #fff; }
        .status-dot.online { background: var(--online); }
        
        .chat-info { flex: 1; overflow: hidden; }
        .chat-info b { font-size: 16px; color: var(--text-main); }
        
        #chatScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--chat-bg); display: none; flex-direction: column; z-index: 200; }
        .chat-header { background: var(--header-bg); padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        
        /* البحث والتعميم */
        .search-container { display: none; padding: 5px 15px; background: var(--header-bg); }
        .search-container input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .msg-dim { opacity: 0.2; transform: scale(0.95); }
        .msg-highlight { border: 2px solid var(--primary-color); z-index: 5; }

        /* نظام الرد */
        .reply-preview-container { display: none; background: rgba(0,0,0,0.05); padding: 8px 15px; border-right: 4px solid var(--primary-color); position: relative; }
        .reply-box-msg { font-size: 12px; background: rgba(0,0,0,0.07); padding: 5px; border-right: 3px solid var(--primary-color); border-radius: 4px; margin-bottom: 4px; color: #666; }

        .messages-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        .message { max-width: 85%; padding: 6px 10px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word; cursor: pointer; transition: all 0.3s ease; }
        .msg-me { align-self: flex-end; background: var(--my-msg); color: #111b21; }
        .msg-friend { align-self: flex-start; background: var(--friend-msg); color: #111b21; }
        .message img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; cursor: zoom-in; }

        .time-stamp { font-size: 10px; color: #667781; display: flex; justify-content: flex-end; align-items: center; gap: 3px; margin-top: 2px; }
        .status-icon { font-size: 11px; }
        .status-icon.sent { color: #8696a0; }
        .status-icon.delivered { color: #8696a0; }
        .status-icon.read { color: #53bdeb; }

        .input-area { background: var(--header-bg); padding: 8px 10px; display: flex; flex-direction: column; }
        .input-controls { display: flex; align-items: center; gap: 10px; width: 100%; }
        .input-controls input { flex: 1; border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 15px; background: #f0f2f5; }
        body.dark-mode .input-controls input { background: #2a3942; color: white; }
        .icon-btn { color: #54656f; cursor: pointer; font-size: 20px; padding: 5px; }
        
        .context-menu { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--header-bg); z-index: 2000; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); transition: bottom 0.3s ease; }
        .context-menu.active { bottom: 0; }
        .menu-item { padding: 15px; font-size: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; color: var(--text-main); cursor: pointer; }
        .menu-item i { width: 20px; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }

        .add-chat-btn { position: absolute; bottom: 20px; left: 20px; width: 55px; height: 55px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 6px 12px rgba(0,168,132,0.4); z-index: 100; }       
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 500; }
        .modal { background: var(--bg-main); color: var(--text-main); width: 85%; padding: 25px; border-radius: 20px; text-align: center; }
        
        #fullImageOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body onclick="smartClose(event)">

<div class="app-container">
    <div id="mainScreen">
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fa-solid fa-moon icon-btn" onclick="toggleDarkMode()" id="darkIcon"></i>
                <h2>SAMOo</h2>
            </div>
            <div style="color:var(--danger); cursor:pointer; font-size: 13px;" onclick="clearAllData()">مسح البيانات</div>
        </header>
        <div class="chats-container" id="chatsList"></div>
        <div class="add-chat-btn" onclick="toggleModal(true)"><i class="fa-solid fa-plus fa-xl"></i></div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <i class="fa-solid fa-arrow-right icon-btn" onclick="closeChat()"></i>
            <div class="avatar" style="width:40px; height:40px;"><i class="fa-solid fa-user"></i></div>
            <div style="flex:1">
                <b id="activeFriendPhone">الرقم</b><br>
                <small id="friendStatusHeader" style="font-size:11px; color:gray">خارج الاتصال</small>
            </div>
            <i class="fa-solid fa-magnifying-glass icon-btn" onclick="toggleSearch()"></i>
        </div>

        <div class="search-container" id="searchBar">
            <input type="text" placeholder="بحث عن رسالة..." oninput="doSearch(this.value)" id="searchInput">
        </div>

        <div class="messages-area" id="msgArea"></div>
        
        <div id="typingIndicator" style="padding: 5px 20px; font-size: 11px; color: var(--online); display: none;">جاري الكتابة...</div>

        <div class="input-area">
            <div class="reply-preview-container" id="replyPreview">
                <div style="font-size:11px; color:var(--primary-color); font-weight:bold;">رد على الرسالة</div>
                <div id="replyTextPreview" style="font-size:13px; color:gray; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <i class="fa-solid fa-xmark" style="position:absolute; left:10px; top:10px; cursor:pointer;" onclick="closeReply()"></i>
            </div>
            
            <div class="input-controls">
                <label for="imageInput" class="icon-btn"><i class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="sendImage(this)">
                <input type="text" id="typeMsg" placeholder="اكتب رسالة..." onkeypress="handleKey(event)" oninput="notifyTyping()">
                <i class="fa-solid fa-paper-plane" style="color:var(--primary-color)" class="icon-btn" onclick="sendMsg()"></i>
            </div>
        </div>
    </div>

    <div class="menu-overlay" id="menuOverlay" onclick="closeContextMenu()"></div>
    <div class="context-menu" id="contextMenu">
        <div class="menu-item" onclick="initReply()">
            <i class="fa-solid fa-reply"></i> رد
        </div>
        <div class="menu-item" onclick="deleteMessage('everyone')">
            <i class="fa-solid fa-trash-can" style="color:var(--danger)"></i> حذف لدى الجميع
        </div>
        <div class="menu-item" style="color: #666" onclick="closeContextMenu()">إلغاء</div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3>إضافة محادثة</h3>
            <input type="tel" id="friendPhone" placeholder="رقم الهاتف">
            <button onclick="addNewChat()" style="width:100%; background:var(--primary-color); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold; margin-top:10px;">ابدأ</button>
            <p onclick="toggleModal(false)" style="margin-top:15px; color:gray; cursor:pointer;">إلغاء</p>
        </div>
    </div>

    <div id="fullImageOverlay" onclick="this.style.display='none'"><img id="fullImg" src="" style="max-width:100%; max-height:100%;"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASN_ZX98SkVa1_fcyUSwHv9sXLDCtkLkY",
    authDomain: "samoo-e789d.firebaseapp.com",
    projectId: "samoo-e789d",
    databaseURL: "https://samoo-e789d-default-rtdb.firebaseio.com",
    storageBucket: "samoo-e789d.firebasestorage.app",
    messagingSenderId: "36670176510",
    appId: "1:36670176510:web:5aa755a4152ea95b3439af"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let myNumber = localStorage.getItem('chat_my_number') || "";
  let friendsList = JSON.parse(localStorage.getItem('my_friends')) || [];
  let currentFriendPhone = null;
  let selectedMsgId = null;
  let selectedMsgText = "";
  let currentReplyData = null;
  let longPressTimer;
  let typingTimeout;

  // الأصوات
  const sndSend = new Audio('https://raw.githubusercontent.com/MoazAlrefai/Whatsapp-Sounds/master/whatsapp_outgoing.mp3');
  const sndRecv = new Audio('https://raw.githubusercontent.com/MoazAlrefai/Whatsapp-Sounds/master/whatsapp_incoming.mp3');

  // --- نظام الحضور ---
  function setupPresence() {
    if(!myNumber) return;
    const myStatusRef = ref(db, 'status/' + myNumber);
    set(myStatusRef, { state: 'online', last_changed: serverTimestamp() });
    onDisconnect(myStatusRef).set({ state: 'offline', last_changed: serverTimestamp() });
  }

  // --- الوضع الليلي ---
  window.toggleDarkMode = () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    document.getElementById('darkIcon').className = isDark ? 'fa-solid fa-sun icon-btn' : 'fa-solid fa-moon icon-btn';
  };

  // --- البحث ---
  window.toggleSearch = () => {
    const sb = document.getElementById('searchBar');
    sb.style.display = sb.style.display === 'block' ? 'none' : 'block';
    if(sb.style.display === 'none') {
        document.querySelectorAll('.message').forEach(m => m.classList.remove('msg-dim', 'msg-highlight'));
        document.getElementById('searchInput').value = "";
    } else {
        document.getElementById('searchInput').focus();
    }
  };

  window.doSearch = (val) => {
    const messages = document.querySelectorAll('.message');
    if(!val) {
        messages.forEach(m => m.classList.remove('msg-dim', 'msg-highlight'));
        return;
    }
    messages.forEach(m => {
        const text = m.innerText.toLowerCase();
        if(text.includes(val.toLowerCase())) {
            m.classList.remove('msg-dim');
            m.classList.add('msg-highlight');
        } else {
            m.classList.add('msg-dim');
            m.classList.remove('msg-highlight');
        }
    });
  };

  // --- نظام الرد ---
  window.initReply = () => {
    currentReplyData = selectedMsgText;
    document.getElementById('replyTextPreview').innerText = selectedMsgText;
    document.getElementById('replyPreview').style.display = 'block';
    closeContextMenu();
    document.getElementById('typeMsg').focus();
  };

  window.closeReply = () => {
    currentReplyData = null;
    document.getElementById('replyPreview').style.display = 'none';
  };

  // الواجهة الذكية
  window.smartClose = (e) => {
    if (e.target.id === "msgArea") {
        closeReply();
        if(document.getElementById('searchBar').style.display === 'block') toggleSearch();
    }
  };

  window.showContextMenu = (msgId, text) => {
    selectedMsgId = msgId;
    selectedMsgText = text;
    document.getElementById('menuOverlay').style.display = 'block';
    document.getElementById('contextMenu').classList.add('active');
  };

  window.closeContextMenu = () => {
    document.getElementById('menuOverlay').style.display = 'none';
    document.getElementById('contextMenu').classList.remove('active');
    selectedMsgId = null;
  };

  window.deleteMessage = (type) => {
    if (!selectedMsgId || !currentFriendPhone) return;
    const chatId = [myNumber, currentFriendPhone].sort().join('_');
    if (type === 'everyone') {
        remove(ref(db, `chats/${chatId}/${selectedMsgId}`));
    } else {
        const msgElement = document.querySelector(`[data-id="${selectedMsgId}"]`);
        if(msgElement) msgElement.style.display = 'none';
    }
    closeContextMenu();
  };

  window.sendImage = (input) => {
    const file = input.files[0];
    if (!file || !currentFriendPhone) return;
    onValue(ref(db, 'status/' + currentFriendPhone), (s) => {
        const friendState = s.val()?.state || 'offline';
        const reader = new FileReader();
        reader.onload = (e) => {
            const chatId = [myNumber, currentFriendPhone].sort().join('_');
            push(ref(db, 'chats/' + chatId), {
                sender: myNumber,
                image: e.target.result,
                time: Date.now(),
                type: 'image',
                status: friendState === 'online' ? 'delivered' : 'sent'
            });
            sndSend.play();
        };
        reader.readAsDataURL(file);
    }, {onlyOnce: true});
    input.value = "";
  };

  window.sendMsg = () => {
    const input = document.getElementById('typeMsg');
    const text = input.value.trim();
    if (!text || !currentFriendPhone) return;

    onValue(ref(db, 'status/' + currentFriendPhone), (s) => {
        const friendState = s.val()?.state || 'offline';
        const chatId = [myNumber, currentFriendPhone].sort().join('_');
        push(ref(db, 'chats/' + chatId), {
            sender: myNumber,
            text: text,
            replyTo: currentReplyData,
            time: Date.now(),
            type: 'text',
            status: friendState === 'online' ? 'delivered' : 'sent'
        });
        input.value = "";
        closeReply();
        sndSend.play();
        set(ref(db, `typing/${currentFriendPhone}/${myNumber}`), false);
    }, {onlyOnce: true});
  };

  function listenForMessages(phone) {
    const chatId = [myNumber, phone].sort().join('_');
    onValue(ref(db, 'chats/' + chatId), (snap) => {
        const area = document.getElementById('msgArea');
        const prevCount = area.childElementCount;
        area.innerHTML = "";
        snap.forEach(c => {
            const m = c.val();
            const msgId = c.key;

            if (m.sender !== myNumber && m.status !== 'read') {
                update(ref(db, `chats/${chatId}/${msgId}`), { status: 'read' });
            }

            const div = document.createElement('div');
            div.className = `message ${m.sender === myNumber ? 'msg-me' : 'msg-friend'}`;
            div.setAttribute('data-id', msgId);
            
            let statusIcon = '';
            if (m.sender === myNumber) {
                if (m.status === 'sent') statusIcon = '<i class="fa-solid fa-check status-icon sent"></i>';
                else if (m.status === 'delivered') statusIcon = '<i class="fa-solid fa-check-double status-icon delivered"></i>';
                else if (m.status === 'read') statusIcon = '<i class="fa-solid fa-check-double status-icon read"></i>';
            }

            let replyContent = m.replyTo ? `<div class="reply-box-msg">${m.replyTo}</div>` : '';
            let content = m.type === 'image' ? `<img src="${m.image}" onclick="showFullImage('${m.image}')">` : m.text;
            
            div.innerHTML = `
                ${replyContent}
                ${content}
                <div class="time-stamp">
                    ${new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    ${statusIcon}
                </div>
            `;

            div.onmousedown = div.ontouchstart = () => longPressTimer = setTimeout(() => showContextMenu(msgId, m.text || "صورة"), 700);
            div.onmouseup = div.ontouchend = () => clearTimeout(longPressTimer);

            area.appendChild(div);
        });
        area.scrollTop = area.scrollHeight;
        if(area.childElementCount > prevCount && area.lastElementChild && !area.lastElementChild.classList.contains('msg-me')) {
            sndRecv.play();
        }
    });
  }

  window.showFullImage = (src) => {
    document.getElementById('fullImg').src = src;
    document.getElementById('fullImageOverlay').style.display = 'flex';
  };

  window.notifyTyping = () => {
    if (!currentFriendPhone) return;
    set(ref(db, `typing/${currentFriendPhone}/${myNumber}`), true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        set(ref(db, `typing/${currentFriendPhone}/${myNumber}`), false);
    }, 2000);
  };

  window.onpopstate = (event) => {
    if (document.getElementById('chatScreen').style.display === 'flex') {
        closeChat(false);
    }
    closeContextMenu();
    toggleModal(false);
  };

  window.openChat = (phone) => {
    currentFriendPhone = phone;
    document.getElementById('activeFriendPhone').innerText = phone;
    document.getElementById('chatScreen').style.display = 'flex';
    if (!history.state || !history.state.chat) history.pushState({chat: 1}, "");
    listenForMessages(phone);
    onValue(ref(db, 'status/' + phone), (s) => {
        const state = s.val()?.state || 'offline';
        document.getElementById('friendStatusHeader').innerText = state === 'online' ? 'متصل الآن' : 'خارج الاتصال';
        document.getElementById('friendStatusHeader').style.color = state === 'online' ? 'var(--online)' : 'gray';
    });
    onValue(ref(db, `typing/${myNumber}/${phone}`), (s) => {
        document.getElementById('typingIndicator').style.display = s.val() ? 'block' : 'none';
    });
  };

  window.closeChat = (p = true) => {
    document.getElementById('chatScreen').style.display = 'none';
    if (p && history.state && history.state.chat) history.back();
  };

  window.renderFriends = () => {
    const list = document.getElementById('chatsList');
    list.innerHTML = "";
    friendsList.forEach(f => {
        const phone = f.phone || f;
        const card = document.createElement('div');
        card.className = 'chat-card';
        card.innerHTML = `
            <div class="avatar-wrapper">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="status-dot" id="dot-${phone}"></div>
            </div>
            <div class="chat-info"><b>${phone}</b></div>
        `;
        card.onclick = () => openChat(phone);
        list.appendChild(card);
        onValue(ref(db, 'status/' + phone), s => {
            const dot = document.getElementById(`dot-${phone}`);
            if(dot) dot.className = `status-dot ${s.val()?.state === 'online' ? 'online' : ''}`;
        });
    });
  };

  window.addNewChat = () => {
    const p = document.getElementById('friendPhone').value.trim();
    if(p && !friendsList.find(i => (i.phone||i) === p)) {
        friendsList.push({phone: p});
        localStorage.setItem('my_friends', JSON.stringify(friendsList));
        renderFriends();
    }
    toggleModal(false);
  };

  window.clearAllData = () => { if(confirm("حذف كل شيء؟")) { localStorage.clear(); location.reload(); } };
  window.toggleModal = (s) => document.getElementById('modalOverlay').style.display = s ? 'flex' : 'none';
  window.handleKey = (e) => e.key === 'Enter' && window.sendMsg();

  window.onload = () => {
    if(!myNumber) {
        myNumber = prompt("رقم هاتفك:");
        if(myNumber) { localStorage.setItem('chat_my_number', myNumber); location.reload(); }
    } else {
        if(localStorage.getItem('darkMode') === 'true') toggleDarkMode();
        setupPresence();
        renderFriends();
    }
  };
</script>
</body>
</html>
