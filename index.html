<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMOo Messenger Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary-color: #0084ff; 
            --chat-bg: #f5f7fb; 
            --my-msg: #0084ff; 
            --my-text: #ffffff;
            --friend-msg: #e4e6eb; 
            --friend-text: #050505;
            --bg-main: #ffffff; 
            --text-main: #1c1e21; 
            --header-bg: rgba(255, 255, 255, 0.9);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body.dark-mode { 
            --bg-main: #18191a; 
            --text-main: #e4e6eb; 
            --chat-bg: #111111; 
            --my-msg: #0084ff; 
            --friend-msg: #3a3b3c; 
            --friend-text: #e4e6eb;
            --header-bg: rgba(24, 25, 26, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: #f0f2f5; overflow: hidden; transition: var(--transition); height: 100vh; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 100vw; background: var(--bg-main); height: 100vh; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--header-bg); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.1); }
        header h2 { font-size: 24px; font-weight: 800; color: var(--text-main); }
        
        .chats-container { flex: 1; overflow-y: auto; padding-top: 5px; }
        .chat-card { display: flex; padding: 12px 16px; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .chat-card:hover { background: rgba(0,0,0,0.03); }
        
        .delete-btn { color: #ff4d4d; padding: 10px; font-size: 18px; opacity: 0.6; transition: 0.2s; }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        .avatar { width: 56px; height: 56px; border-radius: 50%; background: #e4e6eb; display: flex; align-items: center; justify-content: center; font-size: 24px; position: relative; flex-shrink: 0; }
        .chat-info { margin-right: 12px; flex: 1; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; overflow: hidden; }
        .chat-info b { color: var(--text-main); font-size: 16px; display: block; margin-bottom: 2px; }
        .last-msg { color: gray; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 180px; }
        
        #chatScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); display: none; flex-direction: column; z-index: 200; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .chat-header { padding: 10px 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); background: var(--header-bg); }
        .messages-area { flex: 1; padding: 20px 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; background: var(--chat-bg); }
        .message { max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; position: relative; margin-bottom: 2px; }
        .msg-me { align-self: flex-end; background: var(--my-msg); color: var(--my-text); border-bottom-left-radius: 20px; }
        .msg-friend { align-self: flex-start; background: var(--friend-msg); color: var(--friend-text); border-bottom-right-radius: 20px; }
        
        .input-area { padding: 12px; background: var(--bg-main); }
        .input-controls { display: flex; align-items: center; gap: 10px; }
        .input-controls input { flex: 1; border: none; padding: 10px 18px; border-radius: 20px; background: #f0f2f5; outline: none; font-size: 15px; color: var(--text-main); }
        body.dark-mode .input-controls input { background: #3a3b3c; }
        
        .add-chat-btn { position: absolute; bottom: 30px; left: 20px; width: 50px; height: 50px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="app-container">
    <div id="mainScreen" style="display: flex; flex-direction: column; height: 100%;">
        <header>
            <h2>الدردشات</h2>
            <div style="display:flex; gap:18px; align-items:center;">
                <i id="muteBtn" class="fa-solid fa-volume-high" onclick="toggleMute()" style="cursor:pointer; font-size: 20px; color: var(--text-main);"></i>
                <i class="fa-solid fa-circle-half-stroke" onclick="toggleDarkMode()" style="cursor:pointer; font-size: 20px;"></i>
                <div class="avatar" style="width:35px; height:35px; font-size: 14px; background: var(--primary-color); color:white;">أنا</div>
            </div>
        </header>
        <div class="chats-container" id="chatsList"></div>
        <div class="add-chat-btn" onclick="toggleModal(true)"><i class="fa-solid fa-edit"></i></div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <i class="fa-solid fa-chevron-right" onclick="closeChat()" style="cursor:pointer; font-size: 20px; color: var(--primary-color);"></i>
            <div class="avatar" style="width:40px; height:40px;"><i class="fa-solid fa-user"></i></div>
            <div style="flex:1">
                <b id="activeFriendName" style="display:block; font-size: 16px; color: var(--text-main);">الاسم</b>
                <small id="friendStatusHeader" style="font-size:11px; opacity:0.7; color: var(--text-main);">نشط الآن</small>
            </div>
            <i class="fa-solid fa-phone" style="color: var(--primary-color); font-size: 18px; margin: 0 10px;"></i>
            <i class="fa-solid fa-video" style="color: var(--primary-color); font-size: 18px;"></i>
        </div>
        <div class="messages-area" id="msgArea"></div>
        <div class="input-area">
            <div class="input-controls">
                <i class="fa-solid fa-circle-plus" style="color: var(--primary-color); font-size: 22px;"></i>
                <input type="text" id="typeMsg" placeholder="Aa" onkeypress="handleKey(event)">
                <button onclick="sendMsg()" style="background:none; border:none; cursor:pointer;">
                    <i class="fa-solid fa-paper-plane" style="color:var(--primary-color); font-size: 20px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: var(--bg-main); width: 80%; padding: 20px; border-radius: 15px; text-align: center;">
            <h4 style="margin-bottom: 15px; color: var(--text-main);">بدء محادثة</h4>
            <input type="text" id="friendName" placeholder="أدخل اسم الصديق" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;">
            <input type="tel" id="friendPhone" placeholder="أدخل رقم الهاتف" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px;">
            <button onclick="addNewChat()" style="width:100%; background:var(--primary-color); color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">موافق</button>
            <p onclick="toggleModal(false)" style="margin-top:15px; color:gray; cursor:pointer; font-size: 13px;">إلغاء</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASN_ZX98SkVa1_fcyUSwHv9sXLDCtkLkY",
        authDomain: "samoo-e789d.firebaseapp.com",
        projectId: "samoo-e789d",
        databaseURL: "https://samoo-e789d-default-rtdb.firebaseio.com",
        storageBucket: "samoo-e789d.firebasestorage.app",
        messagingSenderId: "36670176510",
        appId: "1:36670176510:web:5aa755a4152ea95b3439af"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const sndSend = new Audio('https://raw.githubusercontent.com/MoazAlrefai/Whatsapp-Sounds/master/whatsapp_outgoing.mp3');
    const sndRecv = new Audio('https://raw.githubusercontent.com/MoazAlrefai/Whatsapp-Sounds/master/whatsapp_incoming.mp3');

    let myNumber = localStorage.getItem('chat_my_number') || "";
    let friendsList = JSON.parse(localStorage.getItem('my_friends')) || [];
    let currentFriendPhone = null;
    let isMuted = localStorage.getItem('isMuted') === 'true';

    // وظيفة حذف الصديق والبيانات
    window.deleteFriend = (e, phone) => {
        e.stopPropagation(); // منع فتح المحادثة عند الضغط على زر الحذف
        if (confirm("هل أنت متأكد من حذف هذا الصديق ومسح جميع الرسائل نهائياً؟")) {
            const chatId = [myNumber, phone].sort().join('_');
            
            // 1. حذف الرسائل من Firebase
            remove(ref(db, 'chats/' + chatId)).then(() => {
                // 2. حذف الصديق من المصفوفة المحلية
                friendsList = friendsList.filter(f => f.phone !== phone);
                localStorage.setItem('my_friends', JSON.stringify(friendsList));
                renderFriends();
                alert("تم حذف الصديق والبيانات بنجاح");
            }).catch(() => {
                alert("حدث خطأ أثناء الحذف");
            });
        }
    };

    function updateFriendPriority(phone, lastMsgText = "") {
        const index = friendsList.findIndex(f => f.phone === phone);
        if (index !== -1) {
            friendsList[index].lastMessageTime = Date.now();
            friendsList[index].lastMsg = lastMsgText;
            localStorage.setItem('my_friends', JSON.stringify(friendsList));
            renderFriends();
        }
    }

    window.toggleMute = () => {
        isMuted = !isMuted;
        localStorage.setItem('isMuted', isMuted);
        document.getElementById('muteBtn').className = isMuted ? "fa-solid fa-volume-xmark mute-btn-active" : "fa-solid fa-volume-high";
    };

    window.toggleDarkMode = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    };

    window.sendMsg = () => {
        const input = document.getElementById('typeMsg');
        const text = input.value.trim();
        if (!text || !currentFriendPhone) return;

        const chatId = [myNumber, currentFriendPhone].sort().join('_');
        push(ref(db, 'chats/' + chatId), {
            sender: myNumber,
            text: text,
            time: Date.now()
        });

        updateFriendPriority(currentFriendPhone, "أنت: " + text);
        if (!isMuted) sndSend.play().catch(() => {});
        input.value = "";
    };

    window.openChat = (phone, name) => {
        currentFriendPhone = phone;
        document.getElementById('activeFriendName').innerText = name || phone;
        document.getElementById('chatScreen').style.display = 'flex';
        listenForMessages(phone);
    };

    function listenForMessages(phone) {
        const chatId = [myNumber, phone].sort().join('_');
        let isFirstLoad = true;
        onValue(ref(db, 'chats/' + chatId), (snap) => {
            const area = document.getElementById('msgArea');
            area.innerHTML = "";
            let lastText = "";
            snap.forEach(c => {
                const m = c.val();
                lastText = (m.sender === myNumber ? "أنت: " : "") + m.text;
                const div = document.createElement('div');
                div.className = `message ${m.sender === myNumber ? 'msg-me' : 'msg-friend'}`;
                div.innerText = m.text;
                area.appendChild(div);
            });
            if (!isFirstLoad && !isMuted && lastText && !lastText.startsWith("أنت:")) sndRecv.play().catch(() => {});
            if (lastText) updateFriendPriority(phone, lastText);
            isFirstLoad = false;
            area.scrollTop = area.scrollHeight;
        });
    }

    window.renderFriends = () => {
        const list = document.getElementById('chatsList');
        list.innerHTML = "";
        const sorted = [...friendsList].sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
        
        sorted.forEach(f => {
            const card = document.createElement('div');
            card.className = 'chat-card';
            card.innerHTML = `
                <div class="avatar" onclick="openChat('${f.phone}', '${f.name}')"><i class="fa-solid fa-user"></i></div>
                <div class="chat-info" onclick="openChat('${f.phone}', '${f.name}')">
                    <b>${f.name || f.phone}</b>
                    <span class="last-msg">${f.lastMsg || "لا توجد رسائل بعد"}</span>
                </div>
                <i class="fa-solid fa-trash-can delete-btn" onclick="deleteFriend(event, '${f.phone}')"></i>
            `;
            list.appendChild(card);
        });
    };

    window.addNewChat = () => {
        const name = document.getElementById('friendName').value.trim();
        const phone = document.getElementById('friendPhone').value.trim();
        if(name && phone) {
            friendsList.push({name, phone, lastMessageTime: Date.now(), lastMsg: ""});
            localStorage.setItem('my_friends', JSON.stringify(friendsList));
            renderFriends();
            listenForLastMsgBackground(phone);
            toggleModal(false);
            document.getElementById('friendName').value = "";
            document.getElementById('friendPhone').value = "";
        }
    };

    window.closeChat = () => { document.getElementById('chatScreen').style.display = 'none'; currentFriendPhone = null; };
    window.toggleModal = (s) => document.getElementById('modalOverlay').style.display = s ? 'flex' : 'none';
    window.handleKey = (e) => e.key === 'Enter' && window.sendMsg();

    window.onload = () => {
        if(!myNumber) {
            myNumber = prompt("أدخل رقمك للبدء:");
            if(myNumber) { localStorage.setItem('chat_my_number', myNumber); location.reload(); }
        } else {
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
            renderFriends();
            friendsList.forEach(f => listenForLastMsgBackground(f.phone));
        }
    };

    function listenForLastMsgBackground(phone) {
        const chatId = [myNumber, phone].sort().join('_');
        const lastMsgQuery = query(ref(db, 'chats/' + chatId), limitToLast(1));
        onValue(lastMsgQuery, (snap) => {
            snap.forEach(c => {
                const m = c.val();
                const text = (m.sender === myNumber ? "أنت: " : "") + m.text;
                updateFriendPriority(phone, text);
            });
        });
    }
</script>
</body>
</html>
